#!/bin/perl -w
#
# https://adventofcode.com/2018/day/18

use strict;
use POSIX;

print "2018 Day 18\n\n";
my $puzzle = do { local $/; <DATA> }; # slurp it
my @lines = split("\n", $puzzle);

my $debugging = 0;

my %grid = ();
my $height = scalar(@lines);
my $width = length($lines[0]);
for (my $y = 0; $y < $height; $y++) {
	for (my $x = 0; $x < $width; $x++) {
		$grid{"$x,$y"} = substr($lines[$y], $x, 1);
	}
}

print_grid("Initial") if $debugging;
my $res = 0;
my @history = ();
my %last_seen = ();
my $cycle = -1;
my $jumped = 0;
my $limit = 1e9;

for (my $min = 1; $min <= $limit; $min++) {
	$res = run_sim();
	print_grid("After $min minutes (res $res)") if $debugging;
	
	if ($min == 10) {
		print "P1: Total resource value after $min minutes is $res.\n";
	}
	
	if (not $jumped) {
		$history[$min] = $res;
		if (exists $last_seen{$res}) {
			my $diff = $min - $last_seen{$res};
			if ($diff == $cycle) {
				print "Found cycle of $cycle after minute $min. Jumping ahead.\n";
				$min += $cycle * POSIX::floor(($limit - $min) / $cycle);
				$jumped = 1;
			} else {
				$cycle = $diff;
			}
		}
		$last_seen{$res} = $min;
	}
}

print "P2: Total resource value after $limit minutes is $res.\n";
exit;

sub run_sim {
	my %changes = ( '.' => [], '|' => [], '#' => [] );
	my $t = 0;
	my $l = 0;

	for (my $y = 0; $y < $height; $y++) {
		for (my $x = 0; $x < $width; $x++) {
			(my ($trees, $lums)) = count_adjacent($x, $y);
			if ($grid{"$x,$y"} eq '.' and $trees >= 3) {
				push @{$changes{'|'}}, "$x,$y";
				$t++;
			} elsif ($grid{"$x,$y"} eq '|') {
				if ($lums >= 3) {
					push @{$changes{'#'}}, "$x,$y";
					$l++;
				} else {
					$t++;
				}
			} elsif ($grid{"$x,$y"} eq '#' ) {
				if ($trees < 1 or $lums < 1) {
					push @{$changes{'.'}}, "$x,$y";
				} else {
					$l++;
				}
			}
		}
	}
	
	foreach my $c (keys %changes) {
		foreach my $cc (@{$changes{$c}}) {
			$grid{$cc} = $c;
		}
	}
	return $t * $l;
}

sub count_adjacent {
	my $cx = shift;
	my $cy = shift;
	
	my $t = 0;
	my $l = 0;
	
	for (my $y = $cy - 1; $y <= $cy + 1; $y++) {
		for (my $x = $cx - 1; $x <= $cx + 1; $x++) {
			next if ($x == $cx and $y == $cy);
			next if ($x < 0 or $x >= $width or $y < 0 or $y >= $height);
			$t++ if ($grid{"$x,$y"} eq '|');
			$l++ if ($grid{"$x,$y"} eq '#');
		}
	}
	
	return ($t, $l);
}

sub print_grid {
	my $title = shift;
	$title = "Grid" unless (defined $title);
	
	print "\n$title\n";
	for (my $y = 0; $y < $height; $y++) {
		my $line = "";
		for (my $x = 0; $x < $width; $x++) {
			$line .= $grid{"$x,$y"};
		}
		print "$line\n";
	}
}

__DATA__
|.|.##|....|#|.#...#.|#.#.....|..#..#|.#..|##.##.|
.|....|.#|.#..|#|..#.|.....#....##.||..#......||.#
|.|...|#..|....#..#.......#......#..#|#|..||.|....
..|||#..#.#||.#..#......||.|#...#.#.|..||.#..|.#||
#.##....##.#|........||..#||#.##.#.|||...|#..|||.#
..#||.#......#||..|.#.##..|##..|#...#|...#......|.
|##.#|#...|||####.##....|.....#....#######.......#
.##..#.......|.#.#|##...|..##......#..|.#..#.#|..#
###..###|#..|.#.#..|.#........|.#||.......#.||||..
|.....|.....|##..|..||.......#|#.#.##.#.##..|.....
|#..|#......|##.......##.|#.|.#......#.|#...|.|..|
..|...##..#..|#.|||##...|.||..|||||||||........#..
#......##...|##|.##..|...........#|.#....#..#.....
.|#..#..|..##.#.||..||....#|##...|#..|.#.........#
......|||.#..........#..|....#|.#|||..||...#...#..
|..#.#|....||.|#.#.|.##.|.||.|#.||..||.|..|..|||..
..#........#.........|..|||.......#..#..#..#||..#|
#..#|..#.....#..###..#||..##..........##......#..|
||......|##....|..|.##....||.|.||.#....|.|...#|.|.
.#|.#.#...|#..#.####..||#.|..|##|.....||.#..||.#..
#.#..........#......#....#..|.#....||.#||.|..|#.||
|###............|#....|.........#.....|###|.....|#
#||...|..|.||..#..|.....#.#..||....#.|##...||.##.#
...|......|.|.|...|#...#|.##..||.|.|.#|....#...##|
.|#....#....#.....#...#...||#|.|...#..|..|###..#..
...#...#|.#.|..#.....|..#..|...#|.....|||..#.|..#|
..|....|..||.....|.#.|.#.||.|.|...|||||.||.....|..
.|...|...|......#|.#...#|..#.|...##.#....#...#..|#
..|||##..#...|.####..|...#.#...|..|#.......||..|.|
..#....#|.|....#...|#|.|||||#####....||.#....|...#
|#..|##..#.....||.##....|...||.....|#....#.#..|..#
#..|#.|||#.#..#|......||#.##..#|#.|..#|.|#|.|.....
....#...#.|.......|....#.#....|...#.|..|#.#.....#.
###..#....|#.|.#.||.##|..#...#..#.|#.|.#.##......|
..#..|##.|.|.|....||....##.|||.#...#.|........#...
.|..#.......|#...#||.|...#..#.#........#.|.##|.#|.
..|||#..|.....#.....##......|...|.|#.|..#..||...#.
..|#.#...##...#.#.|...||.||..|||#..#......|..|##..
.|..#||##|...|..|...||.||#..#||.|##...#....|..|..|
|...||....#.|........||.#..|.|.|..##.#.##.#....#|.
.....#.....|.#...|.#..|.#|..|...#|..|....|.|...|.|
|...|....|......|||...##...|..#.#.#...|........###
##.#......#.......||.#....#.#.....|....|..##.|.##.
|.#.#|......#.......|..#.|...###.||......|#.|....|
#|.||.|.....||.#.|..|..##|.|.#...#..|.##.|....#.#.
||..||.|..#....#..#....|#.........#|...#.||#|#|.|.
|.#..|....#.|#|..#.....|##.|......#.#....#|#.#.#.#
##..||.#|...#...|.#|.|..#|#...|.#..|...|....#.#.#|
.#..#......|.#.#|##.|#........###....##..|.......#
.|.#.#.#||.#...#|..#...............#..#...||##....