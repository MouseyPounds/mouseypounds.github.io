#!/bin/perl -w
#
# https://adventofcode.com/2021/day/20
#

use strict;

print "2021 Day 20\n";
my $input = do { local $/; <DATA> }; # slurp it
my @line = split("\n", $input);
my $enhance = $line[0];
my %image = ('g' => {}, 'xmin' => -1, 'xmax' => 0, 'ymin' => -1, 'ymax' => 0, 'border' => 0);
for (my $i = 2; $i <= $#line; $i++) {
	my $y = $i-2;
	my $x = -1;
	foreach my $c (split('', $line[$i])) {
		$x++;
		$image{'g'}{"$x,$y"} = ($c eq '#') ? 1 : 0;
	}
	if ($i == $#line) {
		$image{'xmax'} = $x + 1;
		$image{'ymax'} = $y + 1;
	}
}

#print_image(\%image, "Start");
enhance_image(\%image, $enhance) for (1..2);
print "Part 1: After 2 image enhancements, there are ", count_pixels(\%image), " pixels on.\n";
enhance_image(\%image, $enhance) for (3..50);
print "Part 2: After 50 image enhancements, there are ", count_pixels(\%image), " pixels on.\n";

sub enhance_image {
	my $i = shift;
	my $e = shift;

	my %change = ();
	
	for (my $x = $i->{'xmin'}; $x <= $i->{'xmax'}; $x++) {
		for (my $y = $i->{'ymin'}; $y <= $i->{'ymax'}; $y++) {
			my $bitstring = "0b";
			$i->{'g'}{"$x,$y"} = $i->{'border'} unless defined $i->{'g'}{"$x,$y"};
			for (my $yy = $y-1; $yy <= $y+1; $yy++) {
				for (my $xx = $x-1; $xx <= $x+1; $xx++) {
					$bitstring .= defined ($i->{'g'}{"$xx,$yy"}) ? $i->{'g'}{"$xx,$yy"} : "$i->{'border'}";
				}
			}
			my $new_pixel = substr($e, oct($bitstring), 1) eq '#' ? 1 : 0;
			$change{"$x,$y"} = $new_pixel if ($new_pixel != $i->{'g'}{"$x,$y"});
		}
	}
	foreach my $p (keys %change) {
		$i->{'g'}{$p} = $change{$p};
	}
	# update borders
	$i->{'xmin'}--; $i->{'ymin'}--;	$i->{'xmax'}++;	$i->{'ymax'}++;
	$i->{'border'} = substr($e, ($i->{'border'} ? 511 : 0), 1) eq '#' ? 1 : 0;
}

sub count_pixels {
	my $i = shift;

	if ($i->{'border'}) {
		return "inf";
	} else {
		my $on = 0;
		for (my $y = $i->{'ymin'}; $y <= $i->{'ymax'}; $y++) {
			for (my $x = $i->{'xmin'}; $x <= $i->{'xmax'}; $x++) {
				$on++ if (defined $i->{'g'}{"$x,$y"} and $i->{'g'}{"$x,$y"});
			}
		}
		return $on;
	}
}

sub print_image {
	my $i = shift;
	my $title = shift;
	$title = "Grid" unless (defined $title);

	print "\n$title\n";
	for (my $y = $i->{'ymin'}; $y <= $i->{'ymax'}; $y++) {
		my $out = "";
		for (my $x = $i->{'xmin'}; $x <= $i->{'xmax'}; $x++) {
			if (defined $i->{'g'}{"$x,$y"}) {
				$out .= $i->{'g'}{"$x,$y"} ? '#' : '.';
			} else {
				$out .= $i->{'border'} ? '#' : '.';
			}
		}
		print "$out\n";
	}
}

__DATA__
##.####..##...##..##.##.###....#..##..#.####.#####..##.#.##.#..#.#####.#.#.....#.####.##.......#.###.#.#..#.##.#.#....####.###..#.####.....##.##.#.#.#.###..#.#..##.####..####...####.#......#...####.#.....##.##.#.#####.#.##...###.#.##.#.#.###.#.####...#####..#.#....######.##.#.###....##...##.#####..##.#.###....#...#...#.#.###.#...##..##........###.#####.###.##....#.##.##..###..#.####....##...###.#####.##..#...###.######.#..#.#...##..#.#####.###.#...#....#.##.#.#.#..#...#####.#..###..#.#...#.#.###.#.#..###.#.

..#.####..###.#.###.##..#...##.#.#..###........#.##...##.#.#...########.#.##...#..##.#.##..##...#.##
#####....#..#.#.#...#.#.#..###.##...#.##.#.#...#.#.##.##.......#....#..###.##..#####..#.#.....###..#
.#.##..#.....#.#.#.#.##.#.#....###.####.#.##...#..##..#.#..#.#####....#.#...##.##...#..#.##...##...#
##...####....#...##..##.#..##..####.###.#....#.#.......##..#....#.##..##..##.#..##.#..##.###.#..###.
...##.#..#..##..#.#..#.#.####.....#..###......#..#.#.###..##.....#.##.#.#..##...##.......##...#..#.#
..#..##.....#.....#...######.#..#.#.#.#.###.##.#...####.#...#.#.#..###..##.#...##.#.#.#.#.#.......##
#.#....#.#.###.##.####..#..####.###...#..##.#.####.####..######......###...##.#.####..###..#.####..#
.##...##..##.#..#.#......##.#.#######.##.#.########.##..#.##.#.#.##...#..#.####.#....##..###..###...
##......##....#.##............#..###....#.###.###.###.#.###.###..##.#...#.##...######.##.##....#.#.#
..#.#.#.##.###.#...###.##.##.##.#.#..####.##...####.#.##.#.#..#.##.###..####..##..##.#.###.###.#.##.
.###....#########.##..###.##.#..####...###.###....#.#..#...######...##..#######.##.##....####.....#.
#.....##.##..##......####..#......#.###.#..#..##.##.#..#......##.##...##.#####.#.#..#.####.##.#.#.#.
...#.#..##..##.##....##....###.#.#####.#.#..##...#...#.#..#.#.#.#.##.#...####.###.#.####.###.....#..
.###.###.#####..####..#....#.####...##..##.......##....#...#..#.##.#.#...##.....##.##....####..#....
.#...#...##..##..#.##.....#######..#########..##....#.####....#.###...##.##..##..#...###..#.###.#...
..#.##..##.#.#.#...#..........##..#...#...##....#..###..##.....#.#..#.#..####.....####..##.#..###...
.##.#.###..###.#..##.#.####...#.#..#....#...#.####..##.#.#..#..##.#....###.#.##.#....##.##.##..#..##
#####..##.#####..#####..##.#.##.#.#..#...#.#.###...##....###..#.#.....#.......###..###..##.#..#.....
##....#..#....#.........####.##.###..#.#.###..####...###...#.#..####....###.#.#...#...#..######.##..
..##.###...#.##......#.##......#.......#..##.#.##..###..###.##.#.#.#.#.....#.#..#...#.##.......#.#.#
#.#..#..####..##.....##..##.....######.#...#....####...#..#..##......#...##.###..#...#...##..#.##..#
..###..#.###.....#.#.#.##....##...###..#.#.#..#.##..........#.#.###.#.##...#...#.#.####....#..###..#
..##....#....##.##..#.#.###..####.##.#..#..#.#...#.###.#.#..#.###...##.##.##...##.####..##..###.....
##..##.###.#.##..####....##.##.##.#....##.##...##.#....##.###.#.#..##.#.#.#####..##.###.#.#...#..#..
....#.#..####.....#...#.##....#####.##...#..#..#.#.##...#.##...##....#.##.###..###....#...#.##...#..
#.....##.#..#######.#.#.####.##.#..#####.##.....####..#..###.....#.#..#..##..########..#.#.#..##.#..
#....#####.#.#.#.####.#..##..##.#.#..#..#........##.####..#.###.#..####..##.....#.#.###.##.#.....#..
...##...######..####.#....#..#..###..#.#...##.##..#####.#.###.##..###.#.####.##.#.#.##...##....#.###
..###..#.##...#..#..#####.#..###...####...###.#.#.####....#####.#...#...#.#...#..#...##....#..##....
#..#....#.#.##..#..##...#####.#####.#.#.#...#.#####.#...#####.##.#..#...##..#....#.##.#.###...##.#.#
##.#........##.###..##.#.#.#..#.#...#....#...#..####.#####...#####..###.###.##.....#....##.###..#.##
#.##..###.###.###.##.....#.##.#...#.#.###....##...##.#..#.##.###.####.#####..##..#....#..#.####.#..#
#.###.#######.######.#.........#....###..#.#..#..#.####.###.##.#.#..#.##.#.#.######..#.##...##...#..
##...###.##.##.#####..#.###.#..####..#####....##.###..#.#..###...###..##.#....###.###.#.#####.###..#
###..###..##..##.##.##..####.#..###.##..#.##.######...##..#...#...####....###...#.#...#.#..#.#.#..##
##..##..###....##............###.....#...##.#..#.###.#...#...#######...#...##.#...#..#.######.#.#.#.
...###.##.###...#...#.....#..####.##..#...###.##..#...#.#.....##.####.....######..####...#.#.###.###
.###.#..#####...##...##...#..##.###.#......#.#####.#.#....#.##.##.#.#..##..#...#....#####..#.#..##.#
#..###....#..#.#.###.#...#.#.##.#..#..##.###.....##...##.###.##.....#.#.#..#..###.###.##..###.##.##.
###...##.###..#.#..#......##.#.###.###..###...###...##...#.#.#..#....##..##..#..#...##..##.........#
..#.#.......#.##..###...#...#.#.#.#####..###.######.......#....##.#######...#.######.....#.#...#..#.
.#..##.##..#.#...######....##.###.##....#...##.####.####...#..#.###..#####..##.#.#####...#####..##..
.#..##..#.#...#..###..####..#.####.##.#.##.###...###.....####.##.....#.#####.##..##..#.##.#.#.#...#.
....####.##.###.#...###.#..#...#####.##.##.##...#...#.....#..##..#.####.#..##..#...###..#.#.##.#....
.#..#...#.#..##....#..##.##..#.#..#...#...####.##.#...#..#####....#..#.#.###.....##...####.#..####.#
#.##.###....#.#.##.#...#.##########....######.#.#.##..##.#...#.#...#..####.####.####.........#.#..##
##..###.####.###.....##.###....##.#.#.....#.......####.#....##...##.#.....#...##....###..#....#.##.#
##...##.#.#.#.#..#..#.#.........##...##.####..###.#####.#..###.#..##.##...#..#..##.#...###.#....###.
...#.#.#.####.##.#.##...####.#.#####..##.#...#...#...##...#......##...####...####.#####.###.##.####.
##...#..#.#.####..#..####..######.##.#.##.#.######..#.#..#...#.##.##.##.......###...#.##.#...#.###.#
#.####..##..#.####..#####.##.###.##..######.###..##.#.##.#.##.#..##.#.##.#..###..##.##.####.##.###.#
###.#####.###...####.#.#..##.#..#.#.###.##.#.#.####..####.###......##.....#.###.#..#..#######..####.
.#.#.#..####....##.....##..#####.###.##..###.##.#..###...####.#......#.##.###.#.#.####....####.##...
##..#.##.###..##..######.#.#.#...######.#...#####....####......#..##..##..###.#####.###..#....#..#.#
#.###....#..###........#.....#.##.#.##.#..##....############....#.###...#.#....#.#..#.#.#########...
.....#.#.#.#.#.#..#.#.##..###..#.#..##.#.##.#.###...#..#..########.........###...#####.####..##..###
#..#...#####..#.#....###......#.##..#....#.#.#...##.##.######.......#####..#....##..##..#...#...#..#
..###.##.#..##..##.#.#....##.##.###.#...##....#..#.#.#..........#########...#.####...#.#####....###.
#.####.#####.#.....##.#...#......##...#.#...#.##..#####.#...##...###..#..##.##...##.#...#....#..##.#
..#..######..##.##.#..##.#.....######.##..#.##.#.#..#....###...###..###..#.#.....##.##...##.###....#
#..#.####..#.##.#.#.#.#.#....##....#...#...#.....#.#..#...####.########..#.##.#.##.##.##.##..#####.#
###......#..#....###......##.##..#...##...#.#.##.##..######..###.#.#....##..#####.#.#...##.#...###.#
#.######.##.#.#...#.#..#....######.....#..#####.##..####.##..###.#.#..####.###....#..#..#####..#..##
....#.###....##.#.###.#..#.##...#.##.##..##..###.#..##.######.##....#..##.#...####.#....#.###..###.#
.###...#..######...#..###.####..#...###.###..###.....#...##.#.###.##...###.##.#..#..#.##....#######.
.#..#..#..#######.#..#.#..#..#.#...#.##..#..##....#...#.#...####..#.#.####.....###...#..#..##...#...
.#..###.#.#..#.......#.####...#.####..##.#.#.###..#.##..#.##.##.#..####...#....#.....######.....#...
.#.#.###...#...##..##..##.##.#.....#.....####..##......##...#....#.###.######....#.#....#.#.##....#.
.##.#..#.######...###..##........###.#..#..#.##.#.##.#########.#...#####....#.###..#.#.#.....#....#.
#..##.###.##.#........##.#..##.....##....####.#..###.##.##..#.##.#.####..####..#.####.##.##.#.#..##.
#.#...##....#.#.#.......###...#.####..#.##..#####...###.#....####.....#....#...#..#####.##...####.#.
####.########..#.#......###.###.#.###.###..##.###...#.##.....###.###..#.....#..##.#.#....#..#.##.###
.###....##......##.#...##......##.#.#.#.#....#.######.##.####...##.#.##.####....##.#...###...#..#.##
.######.....##...#.##.#.###.....######.##.####..##.##.###.#...##.##.#.#..#######.#...#.#..#.#.#..###
...#...###...#..#.#..###......####...#.##.##..#.##..#..#....###.##....#....#.#..#.....##......#..#.#
#..#.#.##..###..####..#.#####.#...##..#.##.#.#...#.#.#.##.#####.#.#####..#.####.##..#.###.#.......##
##.#...#..#...##.#.#.##.##..##...###.##..###....####.##.##....##..#.#.##...##..#..#####.##.#......#.
.#####..#...#.....#.##...###...##.##..##.##.##.##...##.##.###..#..##.###.#..####.......#.#..###.....
###.###.#.#.###.##..####.##....#.##.#####.#..##...###..#..#.##..##..##.##..#.###..##.#..###......#..
#.##....#..###..##.#.##..#...#####.##.#..####..#.#.#....###.###....####............#.#..#..####.####
##..####.....#..###.#..##.##.####..##.#.#.#.###..##..#.##.###.#....###..###..#.....######..###.####.
##..####.#.#...#.#...#.#.##...#.#...#.##....#.#...#.#....###...#.#....###....##.#.#.###...##.####.##
#####...####.###..##.#.##.....###..####.#...##.####..#...##.##...#.###....###.#...###.##....##.####.
#..##..##...#....###.##.####........###.###..#.##.....#####..##...##.#.#.#....#.#..#....#.#.#.#..#..
##..##..###.########...#.#####......###.##...##.##..#......###...####..#.##.##....##....#...#.####.#
.##.####.#.##.##.##.##.###......##...#..##.#.#.##..##.#..##...#.#.#..##....#####.#.####...#.##.#.#.#
#.#..#..#......#######..##.####..#..#####...#....####.#..#.#.#.####.#.....########..#.#...####.##...
#.##..#####....#..#..###.###.##...##...#....#..#.##...#.#..#....#..#..##.....##......#....#..#.....#
.##..##.#.#.#.#.###.#..#...##.....#.##.#.#.....##.###......#..####...#####.#.###..##...#...#.#...#.#
#....##.##.#.#.###..#......#....#..#.#.#......#....##.####.##.#######.##..##.#..###.#.##.###...###.#
#.#...#.#.####..#...####..######.####...##...#.....###.##.####......#.##..#.##..#.##....##...###...#
.#####..#.###.###.###.##..##.###..##..#.....#...#..#..#####..##..##....###.##..######.##...##.##..##
#.##.....##.####.##.##.##..###.#..#..#.#...###.....#..#.##.######...#.##..#...#..#..#.#.###...#.....
#..#.#.#...###.#.####.#.#.#######.######...##.####.#..#..###.#.####.#...#.###.####.....####...#...##
##.....#.##......#......####....#.#.#.###...#....#.....####.#.#...#.##..#....#.#..##..#..##.##...#..
.#.##...####.#..#.#...#.#...#.#....#.#..#..#.#..##.#.#..##.##.#.####.#.###..#######....###..####....
####.##.#######.##.####..#.#...##..#.#...##.#.#...##.##....#.#...###.#.#..##...##..##...#..##...#.#.
#....#..#....#......#..#..##.#....##.#.#.#....###..####.##.#.#.#...#...#####....#..###.######.#..###
#.##...#.###.###.#.#.####..##..#....##..#.##.###..##.#...#.##.....###...###.#...#..#.##.##....######
#..#..####.##.###.....#.#.......##.....#.##.#######...###..#.###.#.####.####..#.#.#...#.##.##...####