#!/bin/perl -w
#
# https://adventofcode.com/2019/day/20
#

use strict;

use POSIX;

my $tracing = 0;

print "\nDay 20:\n";
my %grid = ( );
my $x = 0;
my $y = 0;
my $width = 0;
my $height = 0;
while (<DATA>) {
	chomp;
	my @tiles = split '';
	for ($x = 0; $x <= $#tiles; $x++) {
		$grid{"$x,$y"} = $tiles[$x];
	}
	$y++;
}
$width = $x;
$height = $y;

# find teleporters & start and end points
my %teleport = ();
foreach my $g (keys %grid) {
	($x, $y) = $g =~ /(.*),(.*)/;
	my $label = "";
	my $enter = "";
	my $exit = "";
	if ($grid{$g} =~ /[A-Z]/) {
		if (exists $grid{($x - 1) . ",$y"} and $grid{($x - 1) . ",$y"} =~ /([A-Z])/ and
			exists $grid{($x - 2) . ",$y"} and $grid{($x - 2) . ",$y"} eq '.') {
			$label = "$1$grid{$g}";
			$enter = ($x - 1) . ",$y";
			$exit = ($x - 2) . ",$y";
		} elsif (exists $grid{($x + 1) . ",$y"} and $grid{($x + 1) . ",$y"} =~ /([A-Z])/ and
				 exists $grid{($x + 2) . ",$y"} and $grid{($x + 2) . ",$y"} eq '.') {
			$label = "$grid{$g}$1";
			$enter = ($x + 1) . ",$y";
			$exit = ($x + 2) . ",$y";
		} elsif (exists $grid{"$x," . ($y - 1)} and $grid{"$x," . ($y - 1)} =~ /([A-Z])/ and
				 exists $grid{"$x," . ($y - 2)} and $grid{"$x," . ($y - 2)} eq '.') {
			$label = "$1$grid{$g}";
			$enter = "$x," . ($y - 1);
			$exit = "$x," . ($y - 2);
		} elsif (exists $grid{"$x," . ($y + 1)} and $grid{"$x," . ($y + 1)} =~ /([A-Z])/ and
				 exists $grid{"$x," . ($y + 2)} and $grid{"$x," . ($y + 2)} eq '.') {
			$label = "$grid{$g}$1";
			$enter = "$x," . ($y + 1);
			$exit = "$x," . ($y + 2);
		}
		if ($label eq 'AA') {
			$teleport{'start'} = $exit;
			print "Added 'start' coords $exit\n" if $tracing;
		} elsif ($label eq 'ZZ') {
			$teleport{'end'} = $exit;
			print "Added 'end' coords $exit\n" if $tracing;
		} elsif ($label ne '') {
			if (exists $teleport{$label}) {
				# setup teleport coords both ways and remove temp coordinates, including direction
				my $dir = 1;
				$dir = -1 if ($x < 3 or ($width - $x) < 3 or $y < 3 or ($height - $y) < 3);
				print "Adding $label teleports\n" if $tracing;
				$teleport{$teleport{$label}{'enter'}} = {'c' => $exit, 'd' => 0 - $dir, 'label' => $label};
				print "  $teleport{$label}{'enter'} => $teleport{$teleport{$label}{'enter'}}{'c'} ($teleport{$teleport{$label}{'enter'}}{'d'})\n" if $tracing;
				$teleport{$enter} = {'c' => $teleport{$label}{'exit'}, 'd' => $dir, 'label' => $label};
				print "  $enter => $teleport{$enter}{'c'} ($teleport{$enter}{'d'})\n" if $tracing;
				delete $teleport{$label};
			} else {
				# temporarily store these coordinates
				$teleport{$label} = {'exit' => $exit, 'enter' => $enter};
			}
		}
	}
}

# BFS search for shortest path -- part 1 with no "recursion"
my $dist = 0;
($x, $y) = $teleport{'start'} =~ /(.*),(.*)/;
my @queue = ( { 'x' => $x, 'y' => $y, 'd' => $dist } );
my %visited = ( "$x,$y" => 1 );
while (my $p = shift @queue) {
	if ("$p->{'x'},$p->{'y'}" eq $teleport{'end'}) {
		print "P1 Solution: Shortest path found with distance $p->{'d'}\n";
		last;
	}
	$dist = $p->{'d'} + 1;
	foreach my $offset (-1, 1) {
		$x = $p->{'x'} + $offset;
		$y = $p->{'y'};
		if (exists $teleport{"$x,$y"}) {
			($x, $y) = $teleport{"$x,$y"}{'c'} =~ /(.*),(.*)/;
		}
		if (exists $grid{"$x,$y"} and $grid{"$x,$y"} eq '.' and not exists $visited{"$x,$y"}) {
			push @queue, {'x'=>$x, 'y'=>$y, 'd'=>$dist};
			$visited{"$x,$y"} = 1;
		}
		$x = $p->{'x'};
		$y = $p->{'y'} + $offset;
		if (exists $teleport{"$x,$y"}) {
			($x, $y) = $teleport{"$x,$y"}{'c'} =~ /(.*),(.*)/;
		}
		if (exists $grid{"$x,$y"} and $grid{"$x,$y"} eq '.' and not exists $visited{"$x,$y"}) {
			push @queue, {'x'=>$x, 'y'=>$y, 'd'=>$dist};
			$visited{"$x,$y"} = 1;
		}
	}
}

# BFS search for shortest path -- part 2 with "recursion"
$dist = 0;
my $level = 0;
($x, $y) = $teleport{'start'} =~ /(.*),(.*)/;
@queue = ( { 'x' => $x, 'y' => $y, 'd' => $dist, 'level' => $level } );
%visited = ( "$x,$y,$level" => 1 );
my $found_exit = 0;
my $max_level = 500;
while (my $p = shift @queue) {
	if ("$p->{'x'},$p->{'y'}" eq $teleport{'end'} and $p->{'level'} == 0) {
		print "P2 Solution: Shortest path found with distance $p->{'d'}\n";
		$found_exit = 1;
		last;
	}
	$dist = $p->{'d'} + 1;
	foreach my $offset (-1, 1) {
		$x = $p->{'x'} + $offset;
		$y = $p->{'y'};
		$level = $p ->{'level'};
		if (exists $teleport{"$x,$y"} and ($level > 0 or $teleport{"$x,$y"}{'d'} > 0)) {
			$level += $teleport{"$x,$y"}{'d'};
			($x, $y) = $teleport{"$x,$y"}{'c'} =~ /(.*),(.*)/;
		}
		if (exists $grid{"$x,$y"} and $grid{"$x,$y"} eq '.' and not exists $visited{"$x,$y,$level"} and $level < $max_level) {
			push @queue, {'x'=>$x, 'y'=>$y, 'd'=>$dist, 'level'=>$level};
			$visited{"$x,$y,$level"} = 1;
		}
		$x = $p->{'x'};
		$y = $p->{'y'} + $offset;
		$level = $p ->{'level'};
		if (exists $teleport{"$x,$y"} and ($level > 0 or $teleport{"$x,$y"}{'d'} > 0)) {
			$level += $teleport{"$x,$y"}{'d'};
			($x, $y) = $teleport{"$x,$y"}{'c'} =~ /(.*),(.*)/;
		}
		if (exists $grid{"$x,$y"} and $grid{"$x,$y"} eq '.' and not exists $visited{"$x,$y,$level"} and $level < $max_level) {
			push @queue, {'x'=>$x, 'y'=>$y, 'd'=>$dist, 'level'=>$level};
			$visited{"$x,$y,$level"} = 1;
		}
	}
}
print "P2 Solution: No exit path found\n" if (not $found_exit);

__DATA__
                                     C           T     N Z       D   C       X P                                         
                                     Y           L     Z Z       M   V       Z P                                         
  ###################################.###########.#####.#.#######.###.#######.#.#######################################  
  #.#.#.#.#.#...#.......#...#.........#...#...........#.#.....#.....#.......#...............#.............#...#.......#  
  #.#.#.#.#.###.#.###.###.###.###.###.#.#.###.#.###.###.#.#.#####.#.#.###.#########.###.#####.#.###.###.#####.#####.###  
  #.....#...#.....#.#.........#...#.....#...#.#.#...#.#...#.#.....#.#.#.#.....#.......#...#...#...#...#.#.....#...#.#.#  
  #####.###.#######.###.#.#.###.###.#.###.#########.#.#.###.#.#########.###.#####.#####.#####.#########.###.###.###.#.#  
  #...........#.......#.#.#.#...#...#.#.......#.......#.#...#.......#.#.........#.#.#.....#.#.......#.#.#.......#.....#  
  #####.#.#.#######.#.###.#####.#####.#####.#######.###.###.###.#####.#.###.#####.#.###.###.#.#.#####.#####.#.###.#.###  
  #.....#.#.....#.#.#.#.#...#...#.....#.....#.#.#.....#...#...#...#.......#...#.#...#.#.......#...#.#...#...#.#...#...#  
  #.#.#.#.#####.#.###.#.###########.#######.#.#.###.#.#####.#####.###.#.###.#.#.#.###.#.###.#######.#.#####.#####.#####  
  #.#.#.#.#.#.#.........#...#...#...#.#.#...#...#.#.#...#...#...#...#.#...#.#.#.#...#.....#.....#.#.....#...#.#...#...#  
  #.#.#.#.#.#.#.###.#.#.###.###.#####.#.#.###.#.###.#.###.#.###.###.#.#########.#.#######.#.#.###.#.#.#####.#.#.#.###.#  
  #.#.#.#.#.....#.#.#.#.#.....#.......#.#.#...#.....#...#.#.#.....#.#.....#...#.........#.#.#...#...#.#...#.....#.#...#  
  #######.#######.#####.###.###.#####.#.#.###.###.#.#######.###.#.#.#.#####.###.#######.###.#####.#.###.###.#.#.###.#.#  
  #.#...#.#.#.#...#...#...#.#.#.#...#.#...#.....#.#.#...#...#.#.#...#...#...#.......#.....#.......#...#...#.#.#.#.#.#.#  
  #.###.###.#.#.#.#.###.###.#.#####.#.#.#.###.#######.#####.#.#.#.#.#.###.###.#############.#.###.#######.#.#####.###.#  
  #.#.....#.....#.................#.....#.#.#...#.....#.#.#.#...#.#.#.....#.#.#...#.....#...#.#.#.#...#.......#...#...#  
  #.###.#.###.#####.#.#.#.#####.###.#.#.###.#.#.###.#.#.#.#.#.#.#.#####.###.#.#.###.###########.#####.###.#######.###.#  
  #...#.#.#...#.....#.#.#.#...#.#...#.#.#.....#...#.#.....#.#.#.#...#...#...#...#.#.#.#.....#...#.....#.....#.#.....#.#  
  ###.#.###.#.###.#.#########.#.###.#.###.###.#.#####.###.#.#.#######.#####.#.###.#.#.#.#######.#####.###.###.###.###.#  
  #...#.#.#.#.#...#.#...#.........#.#.#...#.#.#.#.......#.#.#.....#...#.....#...........#.#.#.#.#.#.....#...#.#.....#.#  
  ###.#.#.#######.#####.#######.#####.#####.#.#########.#.#.###.#####.#.###.#.#.#.###.###.#.#.#.#.#.#.###.###.#.#####.#  
  #.........#...#...#.#.#.............#...#.......#.....#...#.......#.#.#...#.#.#...#.....#...#.#...#...#.#...#.#.#.#.#  
  #####.#.###.#######.#.#####.#######.#.###.#.#.###.#.#######.#######.#.#.###.#.#.#########.###.###.#####.#.###.#.#.#.#  
  #.....#...#.....#.#...#.....#.#.#.....#...#.#.#.#.#.......#...#...#.#.#.#.#.#.#...#...#...#.........#...#.#...#.#.#.#  
  #####.#.#####.###.#.#########.#.###.#####.#.###.#########.#.###.###.#.#.#.#.#########.###.###.#########.#.###.#.#.#.#  
  #...#.#.#.#.......#.#.#.....#.#.........#.#...#...#.......#.......#.#.#...#.#.#...#...#...........#...#.#.....#.....#  
  ###.###.#.###.###.#.#.#.###.#.###.#.#######.###.###.#######.###.###.#.###.#.#.###.#.#.#######.#####.###.#.#.###.#.###  
  #.......#.#.#...#.#...#.#...#.#...#.#.....#.....#.#.....#.#...#.#.#.#.#.#.#...#...#.#.....#.....#.#.#...#.#...#.#...#  
  #####.#.#.#.#####.#.#######.#.#####.#.#####.#.###.###.#.#.#.#####.#.#.#.#.#.###.#####.#######.###.#.#.#####.###.#####  
  #...#.#.......#.......#...................#.#...#.....#.#.........#...#...#...........#.#.......#.#...#.#.....#...#.#  
  ###.###.#######.###.#################.#####.###########.#######.#######.#####.#.#######.#.#####.#.###.#.###.###.#.#.#  
  #.#...#.#.#...#.#...#.#.....#.#      G     U           U       G       Y     P J      #...#.....#.#.#.#...#.#.#.#.#.#  
  #.###.#.#.#.#.#####.#.###.###.#      Y     M           C       C       O     Y V      ###.#####.#.#.#.###.#.#.#.###.#  
UM....#...#.#.#.#...#.#.#.......#                                                       #.#.#.#...#.........#.........#  
  #.#####.#.#.#####.#.#.#.#.#.###                                                       #.###.#.#.#.#.#.###.#.###.#.###  
  #.............#...#.#.#.#.#.#..LM                                                     #.#...#.#.#.#.#...#.....#.#.#.#  
  #.###.#####.#####.#.#.#.#.###.#                                                       #.#.###.#.#.###.###.#.###.###.#  
  #...#.#...#.............#.....#                                                     TL..#.....#.....#.#...#.#...#.#.#  
  #########.###########.###.#####                                                       #.#####.#.###########.###.#.#.#  
  #...#...............#.#.#.#...#                                                       #.......#...#.......#.#........PY
  #.###.#.###.#.###.#####.###.###                                                       #############.#.#.#############  
YO......#.#...#...#.#.......#...#                                                     WH..#.#.#.#.#.#.#.#...#.#.......#  
  #.#.#.#.#.#.#####.#.#.#####.###                                                       #.#.#.#.#.#.#####.#.#.###.#.###  
  #.#.#.#.#.#.#.......#.#.#.#.#..AM                                                     #.#.#...#.#.#.....#.#.#...#....KK
  #######.###.#####.###.#.#.#.#.#                                                       #.#.#.###.#.#####.#.#.#.###.###  
  #...#...#...#.#.....#.........#                                                       #.......#.....#.#.#.....#...#.#  
  #.###########.#############.###                                                       #####.#.###.#.#.#.###.###.#.#.#  
  #...#.#...#.#...#.........#.#..XI                                                     #...#.#.....#.....#.....#.#.#.#  
  #.###.#.###.###.#.###.#######.#                                                       ###.###.#####################.#  
  #.#...#.#...#.#.#.#.....#.....#                                                       #...#.#.#...#.#.........#.....#  
  #.#.###.#.#.#.#.#.#.#####.#####                                                       ###.#.###.###.#.#.#.###.#.###.#  
AW..........#.......#...........#                                                       #.#.....#...#...#.#.#.....#...#  
  ###############################                                                       #.#.###.#.#.#.#.###.###.###.###  
  #.......#.....................#                                                     CV..#...#...#...#...#...#.#.....#  
  ###.###.#.###.###.#.#.###.###.#                                                       #.###.###.#.#.###.###########.#  
  #...#...#...#.#...#.#.#...#.#..HB                                                     #.....#...#.#.#.#.#.#.....#.#..CQ
  ###.#.#####.#.#####.#####.#.#.#                                                       #.###.###.#####.###.###.###.###  
GL..#.#.....#.#.#...#.#...#...#.#                                                       #...#...#.#.#...#...#.#.......#  
  #.#.#.#.#.#.#####.###.#########                                                       ###########.###.#.#.#.#.#####.#  
  #...#.#.#.....#.#.......#.#...#                                                       #...#.#.........#.#...#.....#.#  
  ###############.#.#######.#.###                                                       ###.#.#####.###.#####.#####.#.#  
PN....#.................#.....#.#                                                       #.#.....#.#...#.#...........#..JV
  #.#.#.###.#.#########.###.#.#.#                                                       #.###.###.#.#.#####.#.#.###.###  
  #.#.#...#.#.#.........#...#.#..NZ                                                   CY............#.......#.#.#.#.#.#  
  ###.###.###.#.###.#######.#.#.#                                                       #######.#######.#########.###.#  
  #.....#...#.#.#.....#...#.#.#.#                                                     DM......#.#...#...#.#...#...#....AM
  #.#.###.###########.#.#.#.#.#.#                                                       ###.#####.#.#####.#.###.#.#.#.#  
  #.#...........#.......#...#...#                                                       #.#.#...#.#...#.#.......#.#.#.#  
  ###############.###########.#.#                                                       #.#.###.#.#.###.###.#.###.#.###  
  #.#.....#.....#.#.......#.#.#.#                                                       #...#.....#...#...#.#.#...#...#  
  #.#.#.###.#######.###.###.###.#                                                       #.#.###.###.#.###.#.###.#####.#  
  #...#.#.#...#.#.#...#.......#.#                                                       #.#.......#.#.........#.......#  
  #.###.#.#.###.#.###.#####.#####                                                       #######.#.#.###.#.#####.#.###.#  
YF..#.#.........#...#...#...#....PN                                                   XZ......#.#.#.#.#.#.#.....#.#.#.#  
  #.#.#######.###.#.###.###.#.###                                                       #####.#####.#.#.###########.###  
  #.#.#.#.#.......#.......#.....#                                                       #.........#.#.#.#.#...........#  
  ###.#.#.###.#######.#.#########                                                       #.###########.###.#.###.#######  
  #.......#...#.#...#.#...#.#....KY                                                     #.......#.#.....#...#.#.......#  
  #####.#.#####.#.#########.###.#                                                       #.#.###.#.###.###.###.#.#######  
YA..#...#.....#.#...#...#.#.....#                                                       #.#...#.............#..........KY
  #.###.###.###.#.#.#.#.#.#.#####                                                       #.#########.#.#.#####.#.#.#.#.#  
  #.......#.......#...#.........#                                                       #...#.......#.#.#.#...#.#.#.#.#  
  #.#######.###.###.#.#.#.#.###.#      A       K   C       G       Y     Y     P        #.#######.#.###.#.#######.#####  
  #.#.......#...#...#.#.#.#...#.#      W       K   Q       L       A     F     P        #...#.....#...#...#.#.#.......#  
  #.###.#####.###.#.#.#.#.#.###.#######.#######.###.#######.#######.#####.#####.#################.#.###.###.#.###.#.###  
  #.#...#...#.#...#.#.#.#.#...#.#.......#.........#.#.#.#.....#.#.#.....#.#.......#.....#...#.#...#...#.......#...#.#.#  
  #####.###.#######.#####.#.#######.#.#####.#####.#.#.#.#.#####.#.###.###.###.###.#.#.###.###.###.###.#.###.#####.###.#  
  #.........#...........#.#.......#.#.....#...#.#.#...#.#...........#.#.....#.#.....#.........#.....#.#.#.....#.#.#...#  
  #####.#######.#####.###.#.###.#####.#.#####.#.#####.#.###.#.#######.#.#.#####.###.#.###.###.#########.###.###.#.###.#  
  #.......#.....#...#...#.#...#.#...#.#.....#.....#.#.....#.#...#.....#.#.#.#.#.#.#.#...#.#...#...#.......#.....#.#.#.#  
  #.###.###.#.#.###.#.#####.#.###.#####.#.###.#.#.#.#.#.#####.#####.###.###.#.###.###.#.#####.###.#.###.###.###.#.#.#.#  
  #...#...#.#.#.#.....#.#...#.#.#...#...#...#.#.#.#...#...#.#.....#...#.#.#...#.......#...#.....#...#...#...#...#.....#  
  #.#########.#####.#.#.#.#.###.#.#######.#####.#######.###.#.#.###.###.#.###.#######.#.###.#.#.###.###.#####.#######.#  
  #.....#.......#...#...#.#.#...#...........#.......#.....#...#...#...#.......#.#...#.#.#...#.#.#.#.#.#...#...#.......#  
  ###.#####.#.###.#.#####.#.###.###.#.#.#.#.###.#.#####.#####.#####.#####.###.#.###.#.#.###.#.###.#.#.#.#.###.###.###.#  
  #...#.#...#...#.#...#...#.#.#.....#.#.#.#.#...#.#.....#...#.#.......#...#.#...#.#.#.#.#.#.#.....#.#...#.#.#...#...#.#  
  #.###.###.#.#####.#.#######.#.###.#####.#####.#.#####.###.#.###.###.###.#.#.###.#.#.###.###.#######.#.###.#########.#  
  #.#.......#...#.#.#.#...#...#.#.#.#.......#...#.#.#.....#.....#...#...#.#.......#...#.#...#.....#.#.#...........#.#.#  
  #.#.###.#.#####.#.#.###.###.###.#.#.#.#.###.#####.###.###.#.#######.#.#####.#####.#.#.#.#########.###.###.#.#####.###  
  #.#.#...#.#...#.#.#...#.......#.#.#.#.#...#.....#...#.#.#.#.#.#.#...#...#.....#.#.#.......#.#...#.......#.#.........#  
  #####.#######.#.#######.###.###.#######.###.#.#####.#.#.###.#.#.###.#.#.###.###.###.#######.#.#####.###.#####.###.#.#  
  #.......#.........#...#.#.....#...#.#.....#.#.#.......#.#...#.......#.#.#...#...#...............#...#...#.....#...#.#  
  #####.#####.#.#.#.###.#####.#.#.###.###.#####.#.#######.#.#.#.###.#######.#.###.###.###.#######.#########.###.###.#.#  
  #.#...#.....#.#.#...#.#.#...#.............#...#.#.......#.#.#...#.#.....#.#.#.....#...#.....#.........#.....#...#.#.#  
  #.###.###.#########.#.#.#####.###.#.#.###.###.#.#.###.#.#.#####.###.#######.#.###.#.###.#.#.###.#####.###.#.#####.#.#  
  #.......#.#.................#.#.#.#.#.#...#...#.#.#.#.#.#...#.#.....#.#.....#.#.#.#...#.#.#...#...#...#...#.....#.#.#  
  ###.#.###.###########.###.#####.#.#########.###.#.#.#.###.###.#####.#.#.###.#.#.#.#.#######.#.#############.#.#######  
  #.#.#...#.#.#.#...#.....#.#.............#.....#...#.#.#.....#.....#...#.#.#.#.#.#.......#.#.#.#.#.....#...#.#.......#  
  #.#########.#.#.#########.#.#####.#######.#.#.#######.#####.#.###.#.###.#.#.#.#.#.###.###.#####.###.###.#####.#.#.###  
  #.#.......#.....#.#.............#.....#...#.#.#.#...#.#.#...#...#...#...#.#.#.#.#...#.....#.#.............#.#.#.#...#  
  #.#######.#####.#.###.#####.#####.###########.#.#.###.#.###.###.#########.#.#.###.#.#.#####.#.#.#.###.#.###.###.#.#.#  
  #.#.......#.#.........#.#...#...#.#.#.#.....#.#.......#.....#.#...#.#.......#...#.#.#.........#.#...#.#.......#.#.#.#  
  #.#####.###.###.#.#.###.#.#####.#.#.#.###.###.#.#.###.#.#.#.#.#.###.###.###.#.#####.#.#.#.#.#.#####.#############.###  
  #...............#.#.#.....#.........#.........#.#.#...#.#.#.#.........#...#.#.....#.#.#.#.#.#.#.................#...#  
  ###################################.#####.#####.###########.###.###.#####.###.#######################################  
                                     G     H     W           U   A   X     L   G                                         
                                     Y     B     H           C   A   I     M   C                                         